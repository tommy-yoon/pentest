package org.eu.tommyoon.pentesting;

import java.util.ArrayList;

import org.jline.terminal.Terminal;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.shell.Availability;
import org.springframework.shell.result.CommandNotFoundMessageProvider;
import org.springframework.shell.standard.ShellCommandGroup;
import org.springframework.shell.standard.ShellComponent;
import org.springframework.shell.standard.ShellMethod;
import org.springframework.shell.standard.ShellMethodAvailability;
import org.springframework.shell.standard.ShellOption;

import jakarta.validation.constraints.Max;
import jakarta.validation.constraints.Min;

@Configuration
@ShellComponent
@ShellCommandGroup("Main Commands")
public class MyCommands {
	
	@Autowired
	HostService hostService;
	
	@Autowired
	Spinner spinner;
	
	@Autowired
	Terminal terminal;

	@ShellMethod
	public void example() {
		terminal.writer().println("hi");
		terminal.writer().flush();
	}
	
	@ShellMethod(key= {"test", "t"}, value="TEST", group="TEST")
	public void test() {
		System.out.println("test");
	}
	
	@Bean
	CommandNotFoundMessageProvider provider() {
		return ctx -> "Command not found";
	}
	
	/*
	 * scanning
	 */
	@ShellMethod(key = { "scan", "s" }, value = "Scan available IP addresses and open ports. e.g., 192.168.32.0 24")
	public void scan(@ShellOption(help = "IP address", defaultValue = "192.168.137.2") 
	String ipAddress, @Min(0) @Max(32)
			@ShellOption(help = "CIDR e.g., 24 or 30", defaultValue = "30")
	int CIDR) throws Exception{
		if (hostService.isScanned()) {
			System.out.println("Scan data exists - use [list] command");
		} else {
			spinner.start();
			hostService.scan(ipAddress, CIDR);
			spinner.stop();
			list();
		}
	}
	
	/**
	 * list hosts
	 */
	@ShellMethod(key= {"list", "l"}, value="List the available hosts with IP address and open port numbers")
	public void list() {
		ArrayList<Host> hosts = hostService.getHosts();

		int index = 0;
		for (Host host : hosts) {
			index++;
			System.out.printf("[%d] %s : \t", index, host.getIp());
			for (Integer port : host.getOpenPorts()) {
				System.out.printf(" %d", port);
			}
			System.out.printf("\n");
		}
	}
	
	@ShellMethodAvailability({"list"})
	public Availability listAvailability() {
        return hostService.isScanned()
            ? Availability.available()
            : Availability.unavailable("No scanned data exists");
    }
}
